<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Results | Grade 7B System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { 
            --primary: #2c3e50; 
            --accent: #3498db; 
            --success: #27ae60; 
            --danger: #e74c3c; 
            --warning: #f39c12; 
            --light: #f4f7f6; 
            --dark: #1a252f;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--light); margin: 0; display: flex; min-height: 100vh; overflow-x: hidden; }

        /* --- Scrolling Header --- */
        .scrolling-header {
            background: var(--dark); color: white; padding: 10px 0; position: fixed;
            top: 0; left: 250px; right: 0; z-index: 99; overflow: hidden; white-space: nowrap;
            transition: 0.3s ease;
        }
        .scrolling-content {
            display: inline-block; padding-left: 100%; animation: marquee 20s linear infinite;
            font-weight: bold; text-transform: uppercase; letter-spacing: 1px;
        }
        @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }

        /* --- Sidebar --- */
        .sidebar { 
            width: 250px; background: var(--primary); color: white; min-height: 100vh; 
            position: fixed; transition: 0.3s ease; z-index: 100; left: 0; top: 0;
        }
        .sidebar h2 { padding: 20px; font-size: 1.2rem; border-bottom: 1px solid #34495e; margin: 0; text-align: center; }
        .sidebar ul { list-style: none; padding: 0; margin: 0; }
        .sidebar li a { padding: 15px 25px; color: white; text-decoration: none; display: block; border-bottom: 1px solid #34495e; transition: 0.3s; }
        .sidebar li a:hover { background: var(--accent); padding-left: 35px; }

        /* --- Main Content --- */
        .main { 
            flex: 1; margin-left: 250px; padding: 80px 40px 150px 40px; 
            transition: 0.3s ease; width: calc(100% - 250px);
        }

        /* --- New Navigation Buttons CSS --- */
        .nav-buttons-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .back-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
            display: flex;
            align-items: center;
        }
        .back-btn:hover {
            background: var(--accent);
            transform: translateX(-5px);
        }
        .logout-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
        }
        .logout-btn:hover {
            opacity: 0.8;
        }

        .header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 20px; }
        
        .action-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; transition: 0.3s; color: white; }
        .btn-pdf { background: #e67e22; }
        .btn-backup { background: #8e44ad; }
        .btn-restore { background: #16a085; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .performance-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        
        .stat-card, .perf-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .stat-card { text-align: center; border-top: 4px solid var(--accent); }
        .stat-card h3 { margin: 0; color: #7f8c8d; font-size: 0.9rem; text-transform: uppercase; }
        .stat-card p { margin: 10px 0 0; font-size: 1.5rem; font-weight: bold; color: var(--primary); }

        .top-performers { border-left: 5px solid var(--success); background: #f0fff4; }
        .bottom-performers { border-left: 5px solid var(--danger); background: #fff5f5; }

        .table-container { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f8f9fa; color: var(--primary); font-weight: 600; text-align: left; padding: 15px; border-bottom: 2px solid #eee; }
        td { padding: 12px 15px; border-bottom: 1px solid #eee; }
        .summary-row { background: #f1f4f9 !important; font-weight: bold; color: var(--primary); }
        .grade-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; color: white; display: inline-block; min-width: 80px; text-align: center; }

        .footer-container { margin-top: 50px; padding: 30px; background: #fff; border-top: 1px solid #eee; text-align: center; }
        .rotating-badge {
            width: 100px; height: 100px; background: var(--primary); color: white; border-radius: 15px;
            display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;
            font-size: 0.7rem; animation: rotateBadge 8s infinite linear; border: 2px solid var(--accent);
        }
        @keyframes rotateBadge { from { transform: rotateY(0deg); } to { transform: rotateY(360deg); } }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main { margin-left: 0; width: 100%; padding: 80px 15px 150px 15px; }
            .scrolling-header { left: 0; }
            .performance-grid { grid-template-columns: 1fr; }
        }
        
        @media print {
            .sidebar, .action-bar, .nav-buttons-container, .scrolling-header { display: none !important; }
            .main { margin-left: 0; padding: 0; width: 100%; }
        }
    </style>
</head>
<body>
    <nav class="sidebar" id="sidebar">
        <h2>Grade 7B Admin</h2>
        <ul>
            <li><a href="dashboard.html">üè† Dashboard</a></li>
            <li><a href="enrollment.html">üë• Enrollment</a></li>
            <li><a href="mark_entry.html">üìù Enter Marks (2 Subj)</a></li>
            <li><a href="view_marks.html" style="background: var(--accent);">üìú View Results (2 Subj)</a></li>
            <li><a href="all_subject_results.html">üìÇ All Subjects View</a></li>
            <li><a href="index.html">üö™ Logout</a></li>
        </ul>
    </nav>

    <div class="scrolling-header" id="scrolling-header">
        <div class="scrolling-content">
            üìä TERMLY PERFORMANCE REPORT: Reviewing Science & Technology Results | Grade 7B Management System v2.0
        </div>
    </div>

    <main class="main" id="main">
        <div class="nav-buttons-container">
            <button class="back-btn" onclick="location.href='dashboard.html'">‚Üê Back to Dashboard</button>
            <button class="logout-btn" onclick="location.href='index.html'">Logout</button>
        </div>

        <div class="header-flex">
            <div>
                <h1 style="margin:0; color: var(--primary);">Science & Technology Performance</h1>
                <p style="color: #7f8c8d; margin: 5px 0 0;">Ranked Results & Class Analysis</p>
            </div>
            <div class="action-bar">
                <button onclick="window.print()" class="btn" style="background: #34495e;">üñ®Ô∏è Print Report</button>
                <button onclick="exportToPDF()" class="btn btn-pdf">üìÑ Download PDF</button>
                <button onclick="backupData()" class="btn btn-backup">üíæ Backup JSON</button>
                <button onclick="document.getElementById('restoreFile').click()" class="btn btn-restore">üîÑ Restore/Merge</button>
                <input type="file" id="restoreFile" style="display:none" onchange="restoreData(event)">
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card"><h3>Class Mean</h3><p id="class-mean">0.0%</p></div>
            <div class="stat-card" style="border-top-color: var(--success);"><h3>Distinctions</h3><p id="distinction-count">0</p></div>
            <div class="stat-card" style="border-top-color: var(--danger);"><h3>Support Needed</h3><p id="fail-count">0</p></div>
        </div>

        <div class="performance-grid">
            <div class="perf-card top-performers">
                <h3 style="margin-top:0; color:var(--success)">üåü Top 10 Performers</h3>
                <div id="top-list"></div>
            </div>
            <div class="perf-card bottom-performers">
                <h3 style="margin-top:0; color:var(--danger)">‚ö†Ô∏è Support Required (Lowest 10)</h3>
                <div id="bottom-list"></div>
            </div>
        </div>

        <div class="table-container">
            <table id="results-table">
                <thead>
                    <tr>
                        <th>Pos</th>
                        <th>Pupil's Name</th>
                        <th>Sex</th>
                        <th style="text-align: center;">Science</th>
                        <th style="text-align: center;">Tech</th>
                        <th style="text-align: center;">Average</th>
                        <th style="text-align: center;">Grade</th>
                    </tr>
                </thead>
                <tbody id="results-body"></tbody>
                <tfoot id="results-foot"></tfoot>
            </table>
        </div>

        <footer class="footer-container">
            <div class="rotating-badge">MR KATONGO <br> GRADE 7B TEACHER</div>
            <p>&copy; 2026 Grade 7B Performance Tracking System</p>
            <p style="font-size: 0.8rem; color: var(--accent);">Developed by MR. KATONGO CHRISFORD</p>
        </footer>
    </main>

    <script>
        let students = JSON.parse(localStorage.getItem('grade7C_data')) || [];

        // Note: toggleMenu and toggleSidebar functions removed as they are no longer used

        function getGrade(avg) {
            if (avg >= 75) return { g: 'Distinction', c: '#27ae60' };
            if (avg >= 60) return { g: 'Merit', c: '#3498db' }; 
            if (avg >= 50) return { g: 'Credit', c: '#2980b9' };
            if (avg >= 40) return { g: 'Pass', c: '#f39c12' };
            return { g: 'Fail', c: '#e74c3c' };
        }

        function renderResults() {
            const tbody = document.getElementById('results-body');
            const tfoot = document.getElementById('results-foot');
            
            let stats = {
                boys: { sci:0, tech:0, sum:0, count:0 },
                girls: { sci:0, tech:0, sum:0, count:0 }
            };

            let scoredStudents = students.map(s => {
                const sci = parseFloat(s.marks?.science) || 0;
                const tech = parseFloat(s.marks?.technology) || 0;
                const avg = (sci + tech) / 2;
                const gender = (s.gender || 'N/A').toLowerCase();
                
                const target = (gender === 'boy') ? stats.boys : stats.girls;
                target.sci += sci;
                target.tech += tech;
                target.sum += avg;
                target.count++;

                return { ...s, sci, tech, avg };
            });

            scoredStudents.sort((a, b) => b.avg - a.avg);

            tbody.innerHTML = scoredStudents.map((s, i) => {
                const grade = getGrade(s.avg);
                return `
                    <tr>
                        <td><strong>${i + 1}</strong></td>
                        <td><strong>${s.name}</strong></td>
                        <td>${s.gender || 'N/A'}</td>
                        <td style="text-align: center;">${s.sci}%</td>
                        <td style="text-align: center;">${s.tech}%</td>
                        <td style="text-align: center; font-weight: bold;">${s.avg.toFixed(1)}%</td>
                        <td style="text-align: center;"><span class="grade-badge" style="background:${grade.c};">${grade.g}</span></td>
                    </tr>`;
            }).join('');

            const calcMean = (val, count) => count > 0 ? (val / count).toFixed(1) : "0.0";
            const totalCount = stats.boys.count + stats.girls.count;
            const grandAvg = totalCount > 0 ? ((stats.boys.sum + stats.girls.sum) / totalCount).toFixed(1) : "0.0";

            tfoot.innerHTML = `
                <tr class="summary-row">
                    <td colspan="3">Boys Average (${stats.boys.count})</td>
                    <td style="text-align: center;">${calcMean(stats.boys.sci, stats.boys.count)}%</td>
                    <td style="text-align: center;">${calcMean(stats.boys.tech, stats.boys.count)}%</td>
                    <td style="text-align: center;">${calcMean(stats.boys.sum, stats.boys.count)}%</td>
                    <td>-</td>
                </tr>
                <tr class="summary-row">
                    <td colspan="3">Girls Average (${stats.girls.count})</td>
                    <td style="text-align: center;">${calcMean(stats.girls.sci, stats.girls.count)}%</td>
                    <td style="text-align: center;">${calcMean(stats.girls.tech, stats.girls.count)}%</td>
                    <td style="text-align: center;">${calcMean(stats.girls.sum, stats.girls.count)}%</td>
                    <td>-</td>
                </tr>
                <tr class="summary-row" style="background:#2c3e50 !important; color:white !important;">
                    <td colspan="5" style="text-align: right;">GRAND CLASS MEAN:</td>
                    <td style="text-align: center;">${grandAvg}%</td>
                    <td>-</td>
                </tr>`;

            document.getElementById('class-mean').innerText = grandAvg + '%';
            document.getElementById('distinction-count').innerText = scoredStudents.filter(s => s.avg >= 75).length;
            document.getElementById('fail-count').innerText = scoredStudents.filter(s => s.avg < 40).length;

            document.getElementById('top-list').innerHTML = scoredStudents.slice(0, 10).map((s, i) => 
                `<div style="font-size: 0.9em; margin-bottom: 3px;">${i+1}. ${s.name} - <strong>${s.avg.toFixed(1)}%</strong></div>`
            ).join('') || "No data";

            document.getElementById('bottom-list').innerHTML = [...scoredStudents].reverse().slice(0, 10).map((s) => 
                `<div style="font-size: 0.9em; margin-bottom: 3px;">‚Ä¢ ${s.name} (Avg: ${s.avg.toFixed(1)}%)</div>`
            ).join('') || "No data";
        }

        function backupData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(students));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `Grade7B_Backup_${new Date().toLocaleDateString()}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function restoreData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (confirm("Merge with existing data? (Cancel will overwrite)")) {
                        students = [...students, ...imported];
                    } else {
                        students = imported;
                    }
                    localStorage.setItem('grade7C_data', JSON.stringify(students));
                    renderResults();
                    alert("Data updated successfully!");
                } catch (err) { alert("Invalid backup file."); }
            };
            reader.readAsText(file);
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            doc.text("Grade 7B - Science & Technology Results", 14, 15);
            doc.autoTable({ html: '#results-table', startY: 20, theme: 'grid' });
            doc.save("Grade7B_Science_Tech_Results.pdf");
        }

        window.onload = renderResults;
    </script>
</body>
</html>